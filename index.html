<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JavaScriptæ‰«é›·</title>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    
    /* åˆ›å»ºéšå½¢ç›’å­æ’‘å¼€é¡µé¢ */
    .page-container {
        width: 100%;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
        background-color: transparent;
    }
    
    body {
        font-family: 'Microsoft YaHei', Arial, sans-serif;
        background-color: transparent;
        color: #333;
        line-height: 1.6;
        margin: 0;
        padding: 0;
        width: 100%;
        min-height: 100vh;
    }
    
    .game-container {
        width: 100%;
        max-width: 1200px; /* ä¸ç¼–è¯‘å™¨å®¹å™¨å®½åº¦ä¸€è‡´ */
        margin: 0 auto;
        background: #c0c0c0;
        border: 3px outset #fff;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        padding: 20px;
        border-radius: 8px;
    }

    .status-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 10px;
        background: #c0c0c0;
        border: 2px inset #fff;
        border-radius: 4px;
        color: #333;  /* æ·»åŠ æ–‡å­—é¢œè‰² */
    }
    
    .mine-count {
        font-weight: bold;
        font-size: 18px;
    }
    
    .difficulty-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
        justify-content: center;
    }
    
    .difficulty-btn, .new-game-btn {
        padding: 8px 15px;
        background: #f0f0f0;
        border: 2px outset #fff;
        cursor: pointer;
        font-family: 'Microsoft YaHei', Arial, sans-serif;
        border-radius: 4px;
        transition: all 0.3s;
        color: #333;  /* æ·»åŠ é»˜è®¤æ–‡å­—é¢œè‰² */
        font-weight: bold;  /* åŠ ç²—æ–‡å­— */
    }
    
    .difficulty-btn:active, .new-game-btn:active {
        border: 2px inset #fff;
    }
    
    .difficulty-btn.active {
        background: #4568dc;  /* æ›´æ”¹ä¸ºè“è‰²èƒŒæ™¯ */
        border: 2px inset #fff;
        color: white;  /* ç™½è‰²æ–‡å­— */
    }
    
    .new-game-btn {
        font-weight: bold;
        background: #4568dc;
        color: white;
    }
    
    .new-game-btn:hover {
        background: #3a5bc9;
    }

    .grid-container {
        width: 100%;
        overflow: auto;
        margin: 0 auto;
        display: flex;
        justify-content: center;
        padding: 10px;
        background: #a0a0a0;
        border: 2px inset #fff;
        border-radius: 4px;
        min-height: 400px;
        height: auto; /* å…è®¸é«˜åº¦è‡ªé€‚åº” */
    }

    .grid {
        display: grid;
        gap: 1px;
        background: #808080;
        border: 2px inset #fff;
        padding: 2px;
        margin: 0 auto;
        /* ç¡®ä¿ç½‘æ ¼åœ¨åˆå§‹åŠ è½½æ—¶æœ‰å›ºå®šå°ºå¯¸ */
        min-width: 300px;
        min-height: 300px;
    }

    .cell {
        width: 25px;
        height: 25px;
        background: #c0c0c0;
        border: 2px outset #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;  /* å¢å¤§å­—ä½“å¤§å° */
    }

    .revealed {
        border: 1px solid #808080;
        background: #c0c0c0;
    }

    .flagged {
        color: red;
    }
    
    .game-over-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 100;
    }
    
    .game-over-modal {
        background: #c0c0c0;
        border: 3px outset #fff;
        padding: 20px;
        text-align: center;
        width: 300px;
        border-radius: 8px;
    }
    
    .game-over-modal h2 {
        margin-top: 0;
        margin-bottom: 15px;
    }
    
    .game-over-modal p {
        margin-bottom: 20px;
    }
    
    .hidden {
        display: none;
    }
    
    /* æ•°å­—é¢œè‰² */
    .num-1 { color: #0066ff; font-weight: bold; }  /* æ›´äº®çš„è“è‰² */
    .num-2 { color: #00aa00; font-weight: bold; }  /* æ›´äº®çš„ç»¿è‰² */
    .num-3 { color: #ff0000; font-weight: bold; }  /* é²œçº¢è‰² */
    .num-4 { color: #000099; font-weight: bold; }  /* æ·±è“è‰² */
    .num-5 { color: #aa0000; font-weight: bold; }  /* æ·±çº¢è‰² */
    .num-6 { color: #008080; font-weight: bold; }  /* é’è‰² */
    .num-7 { color: #000000; font-weight: bold; }  /* é»‘è‰² */
    .num-8 { color: #666666; font-weight: bold; }  /* ç°è‰² */
    
    @media (max-width: 768px) {
        .difficulty-controls {
            flex-direction: column;
            align-items: center;
        }
        
        .difficulty-btn, .new-game-btn {
            width: 100%;
            max-width: 200px;
        }
        
        .cell {
            width: 20px;
            height: 20px;
            font-size: 12px;
        }
    }
</style>
</head>
<body>
<div class="page-container">
    <div class="game-container">
        <div class="status-bar">
            <div class="mine-count">å‰©ä½™é›·æ•°: <span id="mine-count">20</span></div>
            <button class="new-game-btn" onclick="initGame()">æ–°æ¸¸æˆ</button>
        </div>
        
        <div class="difficulty-controls">
            <button class="difficulty-btn active" onclick="setDifficulty('beginner')">åˆçº§ (12x12)</button>
            <button class="difficulty-btn" onclick="setDifficulty('intermediate')">ä¸­çº§ (16x16)</button>
            <button class="difficulty-btn" onclick="setDifficulty('expert')">é«˜çº§ (19x19)</button>
        </div>
        
        <div class="grid-container">
            <div id="grid" class="grid"></div>
        </div>
        
        <div id="game-over" class="game-over-overlay hidden">
            <div class="game-over-modal">
                <h2 id="game-result">æ¸¸æˆç»“æŸ</h2>
                <p id="game-message"></p>
                <button class="new-game-btn" onclick="closeModal(); initGame();">å†æ¥ä¸€å±€</button>
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆé…ç½®
        const DIFFICULTY = {
            beginner: { rows: 12, cols: 12, mines: 20 },
            intermediate: { rows: 16, cols: 16, mines: 40 },
            expert: { rows: 19, cols: 19, mines: 99 }
        };
        
        let currentDifficulty = 'beginner';
        let ROWS = DIFFICULTY[currentDifficulty].rows;
        let COLS = DIFFICULTY[currentDifficulty].cols;
        let MINE_COUNT = DIFFICULTY[currentDifficulty].mines;
        
        let mineBoard = [];
        let showBoard = [];
        let gameOver = false;
        let flaggedCount = 0;
        let startTime = 0;
        let firstClick = true;
        let isGridRendered = false;  // æ·»åŠ æ ‡å¿—æ¥è·Ÿè¸ªç½‘æ ¼æ˜¯å¦å·²æ¸²æŸ“

        function setDifficulty(difficulty) {
            // æ›´æ–°å½“å‰éš¾åº¦æŒ‰é’®æ ·å¼
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            currentDifficulty = difficulty;
            ROWS = DIFFICULTY[difficulty].rows;
            COLS = DIFFICULTY[difficulty].cols;
            MINE_COUNT = DIFFICULTY[difficulty].mines;
            
            initGame();
        }

        function initGame() {
            gameOver = false;
            flaggedCount = 0;
            firstClick = true;
            document.getElementById('mine-count').textContent = MINE_COUNT;
            
            // éšè—æ¸¸æˆç»“æŸå¼¹çª—
            document.getElementById('game-over').classList.add('hidden');
            
            // åˆå§‹åŒ–æ£‹ç›˜
            mineBoard = Array(ROWS).fill().map(() => Array(COLS).fill(0));
            showBoard = Array(ROWS).fill().map(() => Array(COLS).fill('hidden'));
            
            renderGrid();
            isGridRendered = true;  // è®¾ç½®ç½‘æ ¼å·²æ¸²æŸ“æ ‡å¿—
        }
        
        function placeMines(firstX, firstY) {
            // å¸ƒç½®é›·ï¼ˆç¡®ä¿ç¬¬ä¸€æ¬¡ç‚¹å‡»ä¸æ˜¯é›·ï¼‰
            let minesPlaced = 0;
            while (minesPlaced < MINE_COUNT) {
                const x = Math.floor(Math.random() * ROWS);
                const y = Math.floor(Math.random() * COLS);
                
                // ç¡®ä¿ç¬¬ä¸€æ¬¡ç‚¹å‡»çš„ä½ç½®åŠå…¶å‘¨å›´æ²¡æœ‰é›·
                if (mineBoard[x][y] !== 'M' && 
                    (Math.abs(x - firstX) > 1 || Math.abs(y - firstY) > 1)) {
                    mineBoard[x][y] = 'M';
                    minesPlaced++;
                }
            }
            
            // è®¡ç®—æ•°å­—
            for (let i = 0; i < ROWS; i++) {
                for (let j = 0; j < COLS; j++) {
                    if (mineBoard[i][j] !== 'M') {
                        mineBoard[i][j] = countAdjacentMines(i, j);
                    }
                }
            }
        }

        function countAdjacentMines(x, y) {
            let count = 0;
            for (let i = -1; i <= 1; i++) {
                for (let j = -1; j <= 1; j++) {
                    const newX = x + i;
                    const newY = y + j;
                    if (newX >= 0 && newX < ROWS && 
                        newY >= 0 && newY < COLS &&
                        mineBoard[newX][newY] === 'M') {
                        count++;
                    }
                }
            }
            return count;
        }

        function reveal(x, y) {
            if (gameOver || showBoard[x][y] === 'revealed' || showBoard[x][y] === 'flag') return;
            
            // ç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶å¸ƒç½®é›·
            if (firstClick) {
                placeMines(x, y);
                firstClick = false;
                startTime = Date.now();
            }

            if (mineBoard[x][y] === 'M') {
                gameOver = true;
                revealAllMines();
                showGameOver(false);
                return;
            }

            showBoard[x][y] = 'revealed';
            
            // è‡ªåŠ¨å±•å¼€ç©ºç™½åŒºåŸŸ
            if (mineBoard[x][y] === 0) {
                for (let i = -1; i <= 1; i++) {
                    for (let j = -1; j <= 1; j++) {
                        const newX = x + i;
                        const newY = y + j;
                        if (newX >= 0 && newX < ROWS && 
                            newY >= 0 && newY < COLS &&
                            showBoard[newX][newY] !== 'revealed') {
                            reveal(newX, newY);
                        }
                    }
                }
            }

            checkWin();
            renderGrid();
        }

        function toggleFlag(x, y, event) {
            event.preventDefault();
            if (gameOver || showBoard[x][y] === 'revealed') return;

            if (showBoard[x][y] === 'flag') {
                showBoard[x][y] = 'hidden';
                flaggedCount--;
            } else {
                showBoard[x][y] = 'flag';
                flaggedCount++;
            }

            document.getElementById('mine-count').textContent = MINE_COUNT - flaggedCount;
            renderGrid();
            checkWin();
        }

        function checkWin() {
            if (gameOver) return;
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰éé›·æ ¼å­éƒ½å·²æ­å¼€
            let revealedCount = 0;
            for (let i = 0; i < ROWS; i++) {
                for (let j = 0; j < COLS; j++) {
                    if (showBoard[i][j] === 'revealed') revealedCount++;
                }
            }
            
            if (revealedCount === ROWS * COLS - MINE_COUNT) {
                gameOver = true;
                // è‡ªåŠ¨æ ‡è®°æ‰€æœ‰æœªæ ‡è®°çš„é›·
                for (let i = 0; i < ROWS; i++) {
                    for (let j = 0; j < COLS; j++) {
                        if (mineBoard[i][j] === 'M' && showBoard[i][j] !== 'flag') {
                            showBoard[i][j] = 'flag';
                        }
                    }
                }
                renderGrid();
                showGameOver(true);
            }
        }
        
        function showGameOver(isWin) {
            const modal = document.getElementById('game-over');
            const result = document.getElementById('game-result');
            const message = document.getElementById('game-message');
            
            modal.classList.remove('hidden');
            
            if (isWin) {
                result.textContent = 'æ­å–œä½ èµ¢äº†ï¼';
                const timeTaken = Math.floor((Date.now() - startTime) / 1000);
                message.textContent = `ä½ ç”¨äº†${timeTaken}ç§’å®Œæˆäº†æ¸¸æˆï¼`;
            } else {
                result.textContent = 'æ¸¸æˆç»“æŸ';
                message.textContent = 'å¾ˆé—æ†¾ï¼Œä½ è§¦é›·äº†ï¼';
            }
        }
        
        function closeModal() {
            document.getElementById('game-over').classList.add('hidden');
        }

        function revealAllMines() {
            for (let i = 0; i < ROWS; i++) {
                for (let j = 0; j < COLS; j++) {
                    if (mineBoard[i][j] === 'M') {
                        showBoard[i][j] = 'mine';
                    }
                }
            }
            renderGrid();
        }

        function renderGrid() {
            const grid = document.getElementById('grid');
            if (!grid) return;  // æ·»åŠ å®‰å…¨æ£€æŸ¥
            
            grid.style.gridTemplateColumns = `repeat(${COLS}, 25px)`;
            grid.innerHTML = '';
            
            // ç¡®ä¿ç½‘æ ¼æœ‰å›ºå®šå°ºå¯¸
            const gridWidth = COLS * 25 + 4;
            const gridHeight = ROWS * 25 + 4;
            
            grid.style.width = `${gridWidth}px`;
            grid.style.height = `${gridHeight}px`;
            
            // è®¾ç½®ç½‘æ ¼å®¹å™¨çš„é«˜åº¦ï¼Œç¡®ä¿èƒ½å®Œå…¨æ˜¾ç¤ºç½‘æ ¼ï¼Œå¢åŠ 10pxä»¥æ¶ˆé™¤æ»šåŠ¨æ¡
            const gridContainer = document.querySelector('.grid-container');
            if (gridContainer) {
                gridContainer.style.height = `${gridHeight + 35}px`;  // ä»+20pxæ”¹ä¸º+30px
            }
            
            // è°ƒæ•´æ¸¸æˆå®¹å™¨å®½åº¦ä»¥åŒ¹é…çˆ¶å®¹å™¨
            const gameContainer = document.querySelector('.game-container');
            if (gameContainer) {
                gameContainer.style.width = '100%';
            }
            
            // åˆ›å»ºåˆå§‹ç½‘æ ¼
            for (let i = 0; i < ROWS; i++) {
                for (let j = 0; j < COLS; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    
                    if (showBoard[i][j] === 'revealed') {
                        cell.classList.add('revealed');
                        if (mineBoard[i][j] !== 0) {
                            cell.textContent = mineBoard[i][j];
                            cell.classList.add(`num-${mineBoard[i][j]}`);
                        }
                    } else if (showBoard[i][j] === 'flag') {
                        cell.textContent = 'ğŸš©';
                        cell.classList.add('flagged');
                    }
                    
                    if (showBoard[i][j] === 'mine') {
                        cell.textContent = 'ğŸ’£';
                        cell.style.backgroundColor = '#ff6666';
                    }
                    
                    cell.addEventListener('click', () => reveal(i, j));
                    cell.addEventListener('contextmenu', (e) => toggleFlag(i, j, e));
                    
                    grid.appendChild(cell);
                }
            }
        }

        // æ£€æŸ¥ç½‘æ ¼æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºåˆ™é‡æ–°åˆå§‹åŒ–
        function checkAndReinitializeGrid() {
            const grid = document.getElementById('grid');
            if (grid && (!grid.children.length || grid.children.length === 0)) {
                console.log('æ£€æµ‹åˆ°ç©ºç½‘æ ¼ï¼Œé‡æ–°åˆå§‹åŒ–æ¸¸æˆ');
                // é‡ç½®ä¸ºåˆçº§éš¾åº¦
                resetToBeginner();
                initGame();
            }
        }
        
        // æ–°å¢ï¼šé‡ç½®ä¸ºåˆçº§éš¾åº¦çš„å‡½æ•°
        function resetToBeginner() {
            currentDifficulty = 'beginner';
            ROWS = DIFFICULTY[currentDifficulty].rows;
            COLS = DIFFICULTY[currentDifficulty].cols;
            MINE_COUNT = DIFFICULTY[currentDifficulty].mines;
            
            // æ›´æ–°éš¾åº¦æŒ‰é’®æ ·å¼
            document.querySelectorAll('.difficulty-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.includes('åˆçº§')) {
                    btn.classList.add('active');
                }
            });
            
            // æ›´æ–°å‰©ä½™é›·æ•°æ˜¾ç¤º
            document.getElementById('mine-count').textContent = MINE_COUNT;
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        // ç¡®ä¿DOMå®Œå…¨åŠ è½½åç«‹å³åˆå§‹åŒ–æ¸¸æˆ
        document.addEventListener('DOMContentLoaded', function() {
            initGame();
            // å¼ºåˆ¶ç«‹å³æ¸²æŸ“ç½‘æ ¼ï¼Œç¡®ä¿æ¸¸æˆåŠ è½½æ—¶æ˜¾ç¤ºç”»é¢
            renderGrid();
        });

        // æ·»åŠ å¤‡ä»½åˆå§‹åŒ–æ–¹æ³•ï¼Œä»¥é˜²DOMContentLoadedäº‹ä»¶å·²ç»è§¦å‘
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            setTimeout(function() {
                initGame();
                renderGrid();
            }, 1);
        }

        // æ·»åŠ é¡µé¢å¯è§æ€§å˜åŒ–ç›‘å¬
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                // å½“é¡µé¢å˜ä¸ºå¯è§æ—¶ï¼Œæ£€æŸ¥ç½‘æ ¼æ˜¯å¦éœ€è¦é‡æ–°åˆå§‹åŒ–
                setTimeout(checkAndReinitializeGrid, 100);
            }
        });

        // æ·»åŠ è‡ªå®šä¹‰äº‹ä»¶ç›‘å¬ï¼Œç”¨äºå¤„ç†å¯¼èˆªæ åˆ·æ–°
        window.addEventListener('pageshow', function(event) {
            // pageshowäº‹ä»¶åœ¨æ¯æ¬¡é¡µé¢æ˜¾ç¤ºæ—¶è§¦å‘ï¼ŒåŒ…æ‹¬ä»ç¼“å­˜åŠ è½½
            if (event.persisted) {
                // é¡µé¢ä»ç¼“å­˜åŠ è½½æ—¶ï¼Œé‡ç½®ä¸ºåˆçº§éš¾åº¦
                resetToBeginner();
                setTimeout(checkAndReinitializeGrid, 100);
            }
        });

        // ä¿®æ”¹ï¼šæ·»åŠ å¯¼èˆªæ åˆ·æ–°æ£€æµ‹
        window.addEventListener('load', function() {
            // æ£€æŸ¥æ˜¯å¦æ˜¯é€šè¿‡å¯¼èˆªæ åˆ·æ–°åŠ è½½çš„é¡µé¢
            if (performance && performance.navigation) {
                // navigation.type: 0=ç›´æ¥è®¿é—®, 1=åˆ·æ–°, 2=å‰è¿›/åé€€
                if (performance.navigation.type === 1) {
                    console.log('æ£€æµ‹åˆ°é¡µé¢åˆ·æ–°ï¼Œé‡ç½®ä¸ºåˆçº§éš¾åº¦');
                    resetToBeginner();
                    initGame();
                }
            }
        });

        // æ·»åŠ é¢å¤–çš„å®‰å…¨æªæ–½ï¼Œå®šæœŸæ£€æŸ¥ç½‘æ ¼æ˜¯å¦ä¸ºç©º
        setInterval(function() {
            const grid = document.getElementById('grid');
            if (grid && (!grid.children.length || grid.children.length === 0) && isGridRendered) {
                console.log('å®šæœŸæ£€æŸ¥ï¼šæ£€æµ‹åˆ°ç©ºç½‘æ ¼ï¼Œé‡æ–°åˆå§‹åŒ–æ¸¸æˆ');
                initGame();
            }
        }, 1000); // æ¯ç§’æ£€æŸ¥ä¸€æ¬¡
    </script>
</div>
</body>
</html>